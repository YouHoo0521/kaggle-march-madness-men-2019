---
layout: page
title: Bradley-Terry Model
---

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

<p>
The Bradley-Terry Model is the standard approach for analyzing binary
pairwise data. This applies to our problem because each data instance
represents a binary outcome (whether team1 won the game) on a pair of
teams. We use Bradley-Terry model to estimate the level of each team
and to estimate the winning probabilities for the tournament
games. Furthermore, we do this using Bayesian inference which helps
capture the uncertainty in our predictions and provide useful insight.
</p>

<p>
TLDR:
</p>
<ul class="org-ul">
<li><a href="#org89e9101">Estimated team levels</a> and <a href="#org65ff609">comparison with tournament seeds</a></li>
<li><a href="#org2d6322c">Predicted win probabilities</a> for tournament games</li>
<li>Predictive performance by <a href="#orgfbbed87">log-loss curve</a></li>
</ul>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd414933">1. Model</a>
<ul>
<li><a href="#org761a340">1.1. Full Bayesian Model Statement</a></li>
</ul>
</li>
<li><a href="#org7b78bfb">2. Implementation</a>
<ul>
<li><a href="#org382fefe">2.1. Setup</a></li>
<li><a href="#orgb0735ef">2.2. Stan</a></li>
</ul>
</li>
<li><a href="#orgddb49e1">3. Results</a>
<ul>
<li><a href="#org89e9101">3.1. Estimate of team levels</a></li>
<li><a href="#org65ff609">3.2. Estimated Levels by Seed</a></li>
<li><a href="#org2d6322c">3.3. Winning Probabilities</a></li>
<li><a href="#orgfbbed87">3.4. Log Loss Curve</a></li>
</ul>
</li>
<li><a href="#org7eda21d">4. Discussion</a>
<ul>
<li><a href="#orgb898a26">4.1. So what have we gained from all this work?</a></li>
<li><a href="#org5bbda81">4.2. Next Steps</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgd414933" class="outline-2">
<h2 id="orgd414933"><span class="section-number-2">1</span> Model</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="./research.html#orgecc7140">Bradley-Terry Model</a> assumes that the probability of winning, denoted
\(\pi\), depends on the level of each team, denoted
\(\alpha\). The goal is to estimate \(\alpha\) for every team using the
outcome of the regular season games. Positive \(\alpha\) means that the
team has a winning influence, negative means losing influence, and
zero means that a team is neutral.
</p>

<p>
For (a potentially new) game \(i\) between team
\(j[i]\) and team \(k[i]\), we'll estimate the winning probability for team \(j[i]\) as:
</p>

<p>
\[\pi_i = P(j[i] \text{ win}) = \frac{\exp(\alpha_{j[i]} - \alpha_{k[i]})}{\exp(\alpha_{j[i]} - \alpha_{k[i]}) + 1}\]
</p>

<p>
Here's a table to put things in perspective:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />
</colgroup>

<colgroup>
<col  class="org-right" />
</colgroup>

<colgroup>
<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Difference in Levels (\(\alpha_{j} - \alpha_{k}\))</th>
<th scope="col" class="org-right">Probability of Winning (\(\pi_i\))</th>
<th scope="col" class="org-right">Odds of Winning  (\(\frac{\pi_i}{1-\pi_i}\))</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">50%</td>
<td class="org-right">1:1</td>
</tr>

<tr>
<td class="org-right">0.7</td>
<td class="org-right">67%</td>
<td class="org-right">2:1</td>
</tr>

<tr>
<td class="org-right">1.1</td>
<td class="org-right">75%</td>
<td class="org-right">3:1</td>
</tr>

<tr>
<td class="org-right">1.6</td>
<td class="org-right">83%</td>
<td class="org-right">5:1</td>
</tr>

<tr>
<td class="org-right">2.0</td>
<td class="org-right">88%</td>
<td class="org-right">7.5:1</td>
</tr>

<tr>
<td class="org-right">3.0</td>
<td class="org-right">95%</td>
<td class="org-right">20:1</td>
</tr>

<tr>
<td class="org-right">4.0</td>
<td class="org-right">98%</td>
<td class="org-right">55:1</td>
</tr>

<tr>
<td class="org-right">5.0</td>
<td class="org-right">99.3%</td>
<td class="org-right">150:1</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org761a340" class="outline-3">
<h3 id="org761a340"><span class="section-number-3">1.1</span> Full Bayesian Model Statement</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Here we state the model in more detail for those
interested. Bradley-Terry model can be seen as a logistic regression
onto the level of each team.
</p>
</div>

<div id="outline-container-org9cbf085" class="outline-4">
<h4 id="org9cbf085"><span class="section-number-4">1.1.1</span> Data Likelihood (Logistic Regression)</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
\[y_i \sim Bernoulli(\pi_i)\]
\[\text{logit}(\pi_i) = \alpha_{j[i]} - \alpha_{k[i]}\]
</p>
</div>
</div>

<div id="outline-container-org928e3df" class="outline-4">
<h4 id="org928e3df"><span class="section-number-4">1.1.2</span> Priors</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
For full Bayesian inference, we need to set a prior distribution for
the unknown parameters. We'll start with a normal prior on the
levels:
</p>

<p>
\[\alpha \sim N(0, \sigma^2)\]
</p>

<p>
According to this prior, an average team has a neutral effect on the
outcome of the game. About 68% of teams have levels within 1 standard
deviation away from being neutral, and about 95% of teams within 2
deviations.
</p>

<p>
We start with a noninformative uniform hyperprior on \(\sigma\).
</p>
</div>
</div>

<div id="outline-container-org08786c1" class="outline-4">
<h4 id="org08786c1"><span class="section-number-4">1.1.3</span> Notation</h4>
<div class="outline-text-4" id="text-1-1-3">
<ul class="org-ul">
<li>\(T\): total number of teams in the season</li>
<li>\(j[i] \in \{1,...,T\}\): ID of team1 in game \(i\)</li>
<li>\(k[i] \in \{1,...,T\}\): ID of team2 in game \(i\)</li>
<li>\(y_i = \begin{cases} 1 & \text{ if team1 wins game } i\\ 0 & \text{ otherwise}\end{cases}\)</li>
<li>\(\pi_i\): probability that team1 wins game \(i\)</li>
<li>\(\alpha_{j[i]}, \alpha_{k[i]}\): level of team1 and team2 on winning the game</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org7b78bfb" class="outline-2">
<h2 id="org7b78bfb"><span class="section-number-2">2</span> Implementation</h2>
<div class="outline-text-2" id="text-2">
<p>
We "fit" the model by sampling from the posterior distribution using
MCMC in <code>stan</code>. In simple terms, we simulate thousands of scenarios of the world
based on the observed data. We'll use the model parameters generated
from each scenario to perform inference and prediction.
</p>
</div>

<div id="outline-container-org382fefe" class="outline-3">
<h3 id="org382fefe"><span class="section-number-3">2.1</span> Setup</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org0d42916" class="outline-4">
<h4 id="org0d42916"><span class="section-number-4">2.1.1</span> import</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">import</span> pandas <span style="color: #a020f0;">as</span> pd
<span style="color: #a020f0;">import</span> numpy <span style="color: #a020f0;">as</span> np
<span style="color: #a020f0;">from</span> matplotlib <span style="color: #a020f0;">import</span> pyplot <span style="color: #a020f0;">as</span> plt
<span style="color: #a020f0;">import</span> matplotlib.patches <span style="color: #a020f0;">as</span> mpatches
<span style="color: #a020f0;">import</span> seaborn <span style="color: #a020f0;">as</span> sns
<span style="color: #a020f0;">from</span> src <span style="color: #a020f0;">import</span> utils  <span style="color: #b22222;"># </span><span style="color: #b22222;">see src/ folder in project repo</span>
<span style="color: #a020f0;">from</span> src.data <span style="color: #a020f0;">import</span> make_dataset
<span style="color: #a020f0;">import</span> pystan
<span style="color: #a020f0;">from</span> sklearn.metrics <span style="color: #a020f0;">import</span> log_loss
<span style="color: #a020f0;">import</span> pickle
</pre>
</div>
</div>
</div>

<div id="outline-container-org78b6a78" class="outline-4">
<h4 id="org78b6a78"><span class="section-number-4">2.1.2</span> Helper Functions</h4>
<div class="outline-text-4" id="text-2-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">print_df</span> = utils.create_print_df_fcn(tablefmt=<span style="color: #8b2252;">'html'</span>);
<span style="color: #a0522d;">show_fig</span> = utils.create_show_fig_fcn(img_dir=<span style="color: #8b2252;">'models/bradley_terry/'</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa377c0" class="outline-4">
<h4 id="orgfa377c0"><span class="section-number-4">2.1.3</span> Load Data</h4>
<div class="outline-text-4" id="text-2-1-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">data</span> = make_dataset.get_train_data_v1(2015)
print_df(data.head())
</pre>
</div>

<table>
<thead>
<tr><th style="text-align: right;">  </th><th style="text-align: right;">  season</th><th style="text-align: right;">  daynum</th><th style="text-align: right;">  numot</th><th style="text-align: right;">  tourney</th><th style="text-align: right;">  team1</th><th style="text-align: right;">  team2</th><th style="text-align: right;">  score1</th><th style="text-align: right;">  score2</th><th style="text-align: right;">  loc</th><th style="text-align: right;">  team1win</th><th>seed1  </th><th style="text-align: right;">  seednum1</th><th style="text-align: right;">  seed2</th><th style="text-align: right;">  seednum2</th><th style="text-align: right;">  seeddiff</th><th style="text-align: right;">            ID</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;"> 0</td><td style="text-align: right;">    2015</td><td style="text-align: right;">      11</td><td style="text-align: right;">      0</td><td style="text-align: right;">        0</td><td style="text-align: right;">   1103</td><td style="text-align: right;">   1420</td><td style="text-align: right;">      74</td><td style="text-align: right;">      57</td><td style="text-align: right;"> 1103</td><td style="text-align: right;">         1</td><td>nan    </td><td style="text-align: right;">       nan</td><td style="text-align: right;">    nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">2015_1103_1420</td></tr>
<tr><td style="text-align: right;"> 1</td><td style="text-align: right;">    2015</td><td style="text-align: right;">      11</td><td style="text-align: right;">      0</td><td style="text-align: right;">        0</td><td style="text-align: right;">   1104</td><td style="text-align: right;">   1406</td><td style="text-align: right;">      82</td><td style="text-align: right;">      54</td><td style="text-align: right;"> 1104</td><td style="text-align: right;">         1</td><td>nan    </td><td style="text-align: right;">       nan</td><td style="text-align: right;">    nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">2015_1104_1406</td></tr>
<tr><td style="text-align: right;"> 2</td><td style="text-align: right;">    2015</td><td style="text-align: right;">      11</td><td style="text-align: right;">      0</td><td style="text-align: right;">        0</td><td style="text-align: right;">   1112</td><td style="text-align: right;">   1291</td><td style="text-align: right;">      78</td><td style="text-align: right;">      55</td><td style="text-align: right;"> 1112</td><td style="text-align: right;">         1</td><td>Z02    </td><td style="text-align: right;">         2</td><td style="text-align: right;">    nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">2015_1112_1291</td></tr>
<tr><td style="text-align: right;"> 3</td><td style="text-align: right;">    2015</td><td style="text-align: right;">      11</td><td style="text-align: right;">      0</td><td style="text-align: right;">        0</td><td style="text-align: right;">   1113</td><td style="text-align: right;">   1152</td><td style="text-align: right;">      86</td><td style="text-align: right;">      50</td><td style="text-align: right;"> 1113</td><td style="text-align: right;">         1</td><td>nan    </td><td style="text-align: right;">       nan</td><td style="text-align: right;">    nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">2015_1113_1152</td></tr>
<tr><td style="text-align: right;"> 4</td><td style="text-align: right;">    2015</td><td style="text-align: right;">      11</td><td style="text-align: right;">      0</td><td style="text-align: right;">        0</td><td style="text-align: right;">   1102</td><td style="text-align: right;">   1119</td><td style="text-align: right;">      78</td><td style="text-align: right;">      84</td><td style="text-align: right;"> 1119</td><td style="text-align: right;">         0</td><td>nan    </td><td style="text-align: right;">       nan</td><td style="text-align: right;">    nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">       nan</td><td style="text-align: right;">2015_1102_1119</td></tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgfd94aca" class="outline-4">
<h4 id="orgfd94aca"><span class="section-number-4">2.1.4</span> Process Data</h4>
<div class="outline-text-4" id="text-2-1-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">teams</span> = <span style="color: #483d8b;">set</span>(data[<span style="color: #8b2252;">'team1'</span>].unique()).union(data[<span style="color: #8b2252;">'team2'</span>].unique())
<span style="color: #a0522d;">team_f2id</span> = <span style="color: #483d8b;">dict</span>(<span style="color: #483d8b;">enumerate</span>(teams, 1))  <span style="color: #b22222;"># </span><span style="color: #b22222;">start from 1 for stan's one-based indexing</span>
<span style="color: #a0522d;">team_id2f</span> = {v:k <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> team_f2id.items()}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb0735ef" class="outline-3">
<h3 id="orgb0735ef"><span class="section-number-3">2.2</span> Stan</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orge46e7cc" class="outline-4">
<h4 id="orge46e7cc"><span class="section-number-4">2.2.1</span> Model</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">model_code</span> = <span style="color: #8b2252;">'''</span>
<span style="color: #8b2252;">data {</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=0&gt; T;</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=0&gt; N;  // number of games in regular season</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=0&gt; N_tourney;  // number of games in tournament</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=1, upper=T&gt; j[N + N_tourney];  // index for team 1</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=1, upper=T&gt; k[N + N_tourney];  // index for team 2</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> int&lt;lower=0, upper=1&gt; team1win[N];</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">transformed data {</span>

<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">parameters {</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> real alpha[T];</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> real&lt;lower=0&gt; sigma;  // variance for team levels</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">transformed parameters {</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> real&lt;lower=0, upper=1&gt; pi[N_tourney];  // probability that team1 wins</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> for(n in 1:N_tourney) {</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   pi[n] = inv_logit(alpha[j[N+n]] - alpha[k[N+n]]);</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> }</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">model {</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> vector[N] theta;  // logits</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> alpha ~ normal(0, sigma);</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> for(n in 1:N)</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;">   theta[n] = alpha[j[n]] - alpha[k[n]];</span>
<span style="color: #8b2252; background-color: #f2f2f2;"> </span><span style="color: #8b2252;"> team1win ~ bernoulli_logit(theta);</span>
<span style="color: #8b2252;">}</span>

<span style="color: #8b2252;">generated quantities {</span>

<span style="color: #8b2252;">}</span>
<span style="color: #8b2252;">'''</span>
<span style="color: #a0522d;">sm</span> = pystan.StanModel(model_code=model_code)
</pre>
</div>
</div>
</div>
<div id="outline-container-org4a03d8e" class="outline-4">
<h4 id="org4a03d8e"><span class="section-number-4">2.2.2</span> Data</h4>
<div class="outline-text-4" id="text-2-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">stan_data</span> = {
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'T'</span>: <span style="color: #483d8b;">len</span>(teams),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'N'</span>: (data.tourney == 0).<span style="color: #483d8b;">sum</span>(),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'N_tourney'</span>: (data.tourney == 1).<span style="color: #483d8b;">sum</span>(),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'j'</span>: data[<span style="color: #8b2252;">'team1'</span>].<span style="color: #483d8b;">map</span>(team_id2f).values,
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'k'</span>: data[<span style="color: #8b2252;">'team2'</span>].<span style="color: #483d8b;">map</span>(team_id2f).values,
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'team1win'</span>: data.loc[data.tourney == 0, <span style="color: #8b2252;">'team1win'</span>].values
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org80b05c0" class="outline-4">
<h4 id="org80b05c0"><span class="section-number-4">2.2.3</span> Sample from the Posterior</h4>
<div class="outline-text-4" id="text-2-2-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">fit</span> = sm.sampling(data=stan_data, <span style="color: #483d8b;">iter</span>=1000, chains=4)
<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"bradley-terry.pkl"</span>, <span style="color: #8b2252;">"wb"</span>) <span style="color: #a020f0;">as</span> f:
<span style="background-color: #f2f2f2;"> </span>   pickle.dump({<span style="color: #8b2252;">'model_code'</span>: model_code, <span style="color: #8b2252;">'sm'</span>: sm, <span style="color: #8b2252;">'fit'</span>: fit}, f, protocol=-1)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf7c8a94" class="outline-4">
<h4 id="orgf7c8a94"><span class="section-number-4">2.2.4</span> Model Diagnostics</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
It's important to check that MCMC algorithm converged. This is done
offline to avoid clutter.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgddb49e1" class="outline-2">
<h2 id="orgddb49e1"><span class="section-number-2">3</span> Results</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org89e9101" class="outline-3">
<h3 id="org89e9101"><span class="section-number-3">3.1</span> Estimate of team levels</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">la</span> = fit.extract(permuted=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">extract MCMC samples</span>
<span style="color: #a0522d;">alpha</span> = la[<span style="color: #8b2252;">'alpha'</span>]  <span style="color: #b22222;"># </span><span style="color: #b22222;">estimated team levels</span>
<span style="color: #a0522d;">tourney_teams</span> = <span style="color: #483d8b;">list</span>(<span style="color: #483d8b;">set</span>(data.loc[data[<span style="color: #8b2252;">'tourney'</span>] == 1, [<span style="color: #8b2252;">'team1'</span>, <span style="color: #8b2252;">'team2'</span>]].values.flatten()))
<span style="color: #a0522d;">tourney_teamsf</span> = [team_id2f[t]-1 <span style="color: #a020f0;">for</span> t <span style="color: #a020f0;">in</span> tourney_teams]  <span style="color: #b22222;"># </span><span style="color: #b22222;">subtract 1 for zero-based indexing</span>
<span style="color: #a0522d;">team_seeds</span> = pd.DataFrame(np.vstack([data[[<span style="color: #8b2252;">'team1'</span>, <span style="color: #8b2252;">'seednum1'</span>]].dropna().values,
                                     data[[<span style="color: #8b2252;">'team2'</span>, <span style="color: #8b2252;">'seednum2'</span>]].dropna().values])
                          .astype(<span style="color: #483d8b;">int</span>), columns=[<span style="color: #8b2252;">'team'</span>, <span style="color: #8b2252;">'seed'</span>]).drop_duplicates()
<span style="color: #a0522d;">fig</span>, <span style="color: #a0522d;">axes</span> = plt.subplots(2, 1, sharex=<span style="color: #008b8b;">True</span>)
<span style="color: #a0522d;">bins</span> = np.arange(-4, 5, 0.5)
axes[0].hist(np.mean(alpha, axis=0), edgecolor=<span style="color: #8b2252;">'black'</span>, bins=bins);
axes[1].hist(np.mean(alpha[:, tourney_teamsf], axis=0), edgecolor=<span style="color: #8b2252;">'black'</span>, bins=bins);
axes[0].set_title(<span style="color: #8b2252;">'All Teams'</span>, loc=<span style="color: #8b2252;">'left'</span>)
axes[1].set_title(<span style="color: #8b2252;">'Tournament Teams'</span>, loc=<span style="color: #8b2252;">'left'</span>)
axes[1].set_xlabel(<span style="color: #8b2252;">'Estimated Level'</span>)
<span style="color: #a020f0;">for</span> i <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(2):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #b22222;"># </span><span style="color: #b22222;">axes[i].grid(axis='x')</span>
<span style="background-color: #f2f2f2;"> </span>   axes[i].axvline(0, c=<span style="color: #8b2252;">'r'</span>)
plt.suptitle(<span style="color: #8b2252;">'Estimated Level of Teams'</span>)
show_fig(<span style="color: #8b2252;">'average_team_levels.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="../figs/models/bradley_terry/average_team_levels.png" alt="average_team_levels.png" />
</p>
</div>


<p>
This figure gives us a few insights about our model. Point 1 below
suggests that the model is generally learning the right
pattern. Points 2 and 3 might indicate lack of fit and a potential
direction for model expansion.
</p>

<ol class="org-ol">
<li>Most of the tournament teams have high estimated levels. It looks
like all teams with estimated level beyond 2.5 have made it to the
tournament.</li>
<li>One of the tournament teams has a negative estimated level. What is
this team and how did they make it to the tournament? Before we do
a deep dive, there's a few possibilities:
<ul class="org-ul">
<li>the team had an extremely competitive conference and lost many games.</li>
<li>the team qualified in a non-traditional way (maybe by winning a
qualifying tournament through a series of upsets?). I have no idea
how this process works.</li>
</ul></li>
<li>According to the model, there are several teams that didn't make
the tournament even though they are better than some of the
qualifying teams. For instance, over 30 teams had an estimated
level between 1 and 1.5. However, among qualifying teams, there's
only about 10 teams in that range while about 15 teams have levels
less than 1.0.</li>
</ol>
</div>
</div>


<div id="outline-container-org65ff609" class="outline-3">
<h3 id="org65ff609"><span class="section-number-3">3.2</span> Estimated Levels by Seed</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">team_levels</span> = (pd.DataFrame({
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_mean'</span>:np.mean(alpha[:, tourney_teamsf], axis=0),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_l05'</span>:np.quantile(alpha[:, tourney_teamsf], 0.05, axis=0),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_l25'</span>:np.quantile(alpha[:, tourney_teamsf], 0.25, axis=0),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_median'</span>:np.quantile(alpha[:, tourney_teamsf], 0.50, axis=0),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_u75'</span>:np.quantile(alpha[:, tourney_teamsf], 0.75, axis=0),
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #8b2252;">'alpha_u95'</span>:np.quantile(alpha[:, tourney_teamsf], 0.95, axis=0),
<span style="background-color: #f2f2f2;"> </span>   }, index=tourney_teams)
                .pipe(pd.merge, team_seeds, left_index=<span style="color: #008b8b;">True</span>, right_on=<span style="color: #8b2252;">'team'</span>)
                .pipe(<span style="color: #a020f0;">lambda</span> x: x.sort_values([<span style="color: #8b2252;">'seed'</span>, <span style="color: #8b2252;">'alpha_mean'</span>], ascending=[<span style="color: #008b8b;">True</span>, <span style="color: #008b8b;">False</span>]))
)


<span style="color: #a0522d;">error_bars_50</span> = [team_levels[<span style="color: #8b2252;">'alpha_mean'</span>] - team_levels[<span style="color: #8b2252;">'alpha_l25'</span>],
                 team_levels[<span style="color: #8b2252;">'alpha_u75'</span>] - team_levels[<span style="color: #8b2252;">'alpha_mean'</span>]]
<span style="color: #a0522d;">error_bars_95</span> = [team_levels[<span style="color: #8b2252;">'alpha_mean'</span>] - team_levels[<span style="color: #8b2252;">'alpha_l05'</span>],
                 team_levels[<span style="color: #8b2252;">'alpha_u95'</span>] - team_levels[<span style="color: #8b2252;">'alpha_mean'</span>]]
<span style="color: #a0522d;">fig</span>, <span style="color: #a0522d;">ax</span> = plt.subplots(figsize=(10, 5))
<span style="color: #a0522d;">x</span> = team_levels[<span style="color: #8b2252;">'seed'</span>].values + np.tile([-0.33, -0.17, 0.17, 0.33], 17)
ax.errorbar(x, team_levels[<span style="color: #8b2252;">'alpha_mean'</span>], yerr=error_bars_95, fmt=<span style="color: #8b2252;">'none'</span>, c=<span style="color: #8b2252;">'r'</span>, label=<span style="color: #8b2252;">'90% interval'</span>, lw=0.5)
ax.errorbar(x, team_levels[<span style="color: #8b2252;">'alpha_mean'</span>], yerr=error_bars_50, fmt=<span style="color: #8b2252;">'none'</span>, c=<span style="color: #8b2252;">'k'</span>, label=<span style="color: #8b2252;">'50% interval'</span>, lw=2.5)
ax.scatter(x, team_levels[<span style="color: #8b2252;">'alpha_mean'</span>], c=<span style="color: #8b2252;">'k'</span>, label=<span style="color: #8b2252;">'mean level'</span>)
ax.set_xlabel(<span style="color: #8b2252;">'Seed'</span>)
ax.set_ylabel(<span style="color: #8b2252;">'Estimated Level'</span>)
ax.axhline(0, color=<span style="color: #8b2252;">'k'</span>, linestyle=<span style="color: #8b2252;">'--'</span>, lw=0.5)
ax.set_title(<span style="color: #8b2252;">'Estimated Levels by Seed'</span>)
ax.legend()
show_fig(<span style="color: #8b2252;">'estimated_levels_by_seed.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="../figs/models/bradley_terry/estimated_levels_by_seed.png" alt="estimated_levels_by_seed.png" />
</p>
</div>

<p>
How can we check that our estimates are good? One way is to compare
our estimates against the tournament seeds. The figure above confirms
that the two are in agreement. Note that seeds are assigned within
conference (or region?) so four teams share the same seed.
</p>

<p>
There's some separation in estimated levels among the top two seeds
from every conference, bottom (below 12) seeds, and the rest of the
pack.
</p>
</div>
</div>


<div id="outline-container-org2d6322c" class="outline-3">
<h3 id="org2d6322c"><span class="section-number-3">3.3</span> Winning Probabilities</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">pi</span> = la[<span style="color: #8b2252;">'pi'</span>]
<span style="color: #a0522d;">idx_sorted</span> = np.argsort(np.median(pi, axis=0))
<span style="color: #a0522d;">pi_sorted</span> = pi[:,idx_sorted]
<span style="color: #a0522d;">y_true</span> = data.loc[data.tourney == 1, <span style="color: #8b2252;">'team1win'</span>].values
<span style="color: #a0522d;">y_pred</span> = np.median(pi, axis=0) &gt; 0.5
<span style="color: #a0522d;">color_sorted</span> = np.where(y_true == y_pred, <span style="color: #8b2252;">'b'</span>, <span style="color: #8b2252;">'r'</span>)[idx_sorted]
<span style="color: #a0522d;">nrow</span> = 9
<span style="color: #a0522d;">ncol</span> = 8
<span style="color: #a0522d;">fig</span>, <span style="color: #a0522d;">axes</span> = plt.subplots(nrow, ncol, figsize = (10, 10), sharex=<span style="color: #008b8b;">True</span>)
<span style="color: #a020f0;">for</span> row <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(nrow):
<span style="background-color: #f2f2f2;"> </span> <span style="color: #a020f0;">for</span> col <span style="color: #a020f0;">in</span> <span style="color: #483d8b;">range</span>(ncol):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">idx</span> = row * ncol + col
<span style="background-color: #f2f2f2;"> </span>   axes[row, col].set_yticklabels([])
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">if</span> idx &lt; (y_true.shape[0]):
<span style="background-color: #f2f2f2;"> </span>   <span style="background-color: #f2f2f2;"> </span> axes[row, col].hist(pi_sorted[:,idx], bins=30, color=color_sorted[idx]);
<span style="color: #a0522d;">blue_patch</span> = mpatches.Patch(color=<span style="color: #8b2252;">'blue'</span>, label=<span style="color: #8b2252;">'Correct'</span>)
<span style="color: #a0522d;">red_patch</span> = mpatches.Patch(color=<span style="color: #8b2252;">'red'</span>, label=<span style="color: #8b2252;">'Error'</span>)
fig.legend(handles=[blue_patch, red_patch], loc=<span style="color: #8b2252;">'lower center'</span>)
plt.subplots_adjust(left=<span style="color: #008b8b;">None</span>, bottom=<span style="color: #008b8b;">None</span>, right=<span style="color: #008b8b;">None</span>, top=<span style="color: #008b8b;">None</span>, wspace=0.05, hspace=0.05)
plt.suptitle(<span style="color: #8b2252;">'Posterior Distribution of Winning Probabilities (2015 Tournament)'</span>)
show_fig(<span style="color: #8b2252;">'win_probabilities.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="../figs/models/bradley_terry/win_probabilities.png" alt="win_probabilities.png" />
</p>
</div>

<p>
Here, we use our simulations to predict the winning
probabilities. This is where we can leverage the power of Bayesian
inference.
</p>

<p>
Each subplot above represents a tournament game and the histogram
contains the predicted win probabilities (that team1 will win) over
many simulated scenarios. For convenience, histograms are ordered by
the median predicted win probability.
</p>

<ul class="org-ul">
<li>symmetric and wide histogram means that the two teams are closely
matched and it's difficult to predict who will win</li>
<li>A skewed histogram means that one team is more likely to win than
the other</li>
<li>A narrow histogram means that the model is quite certain about the
probability of winning</li>
</ul>

<p>
In order to check if the model is consistent with observed outcomes, I
used the median predicted probability to decide whether or not team1
is predicted to win. Blue and red histograms indicate whether the
model was correct or not, respectively. Few things to note here:
</p>

<ul class="org-ul">
<li>When the model thinks the teams are closely matched (wide and
centered histograms), the predictions go either way.</li>
<li>When the model thinks there's a mismatch, it is correct more
often than not.</li>
<li>There's a small number of "upsets" when the model is very certain
but wrong. We can deep dive into these games. Upsets can always
happen, but we could gain new insights on how to expand the model.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfbbed87" class="outline-3">
<h3 id="orgfbbed87"><span class="section-number-3">3.4</span> Log Loss Curve</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Let's evaluate the predictions over all seasons using the log-loss
curve as we did for <a href="./benchmark.html#org300a0b3">benchmark models</a>. We can do this by creating a
function that wraps around the essential part of the code for making
the prediction. The code below takes a while and should ideally be run
in parallel.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #a020f0;">def</span> <span style="color: #0000ff;">evaluate</span>(sm, season):
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">data</span> = make_dataset.get_train_data_v1(season=season)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">teams</span> = <span style="color: #483d8b;">set</span>(data[<span style="color: #8b2252;">'team1'</span>].unique()).union(data[<span style="color: #8b2252;">'team2'</span>].unique())
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">team_f2id</span> = <span style="color: #483d8b;">dict</span>(<span style="color: #483d8b;">enumerate</span>(teams, 1))  <span style="color: #b22222;"># </span><span style="color: #b22222;">start from 1 for stan's one-based indexing</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">team_id2f</span> = {v:k <span style="color: #a020f0;">for</span> k, v <span style="color: #a020f0;">in</span> team_f2id.items()}
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">stan_data</span> = {
        <span style="color: #8b2252;">'T'</span>: <span style="color: #483d8b;">len</span>(teams),
        <span style="color: #8b2252;">'N'</span>: (data.tourney == 0).<span style="color: #483d8b;">sum</span>(),
        <span style="color: #8b2252;">'N_tourney'</span>: (data.tourney == 1).<span style="color: #483d8b;">sum</span>(),
        <span style="color: #8b2252;">'j'</span>: data[<span style="color: #8b2252;">'team1'</span>].<span style="color: #483d8b;">map</span>(team_id2f).values,
        <span style="color: #8b2252;">'k'</span>: data[<span style="color: #8b2252;">'team2'</span>].<span style="color: #483d8b;">map</span>(team_id2f).values,
        <span style="color: #8b2252;">'team1win'</span>: data.loc[data.tourney == 0, <span style="color: #8b2252;">'team1win'</span>].values
<span style="background-color: #f2f2f2;"> </span>   }
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">fit</span> = sm.sampling(data=stan_data, <span style="color: #483d8b;">iter</span>=1000, chains=4)
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">la</span> = fit.extract(permuted=<span style="color: #008b8b;">True</span>)  <span style="color: #b22222;"># </span><span style="color: #b22222;">extract MCMC samples</span>
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">pi</span> = la[<span style="color: #8b2252;">'pi'</span>]
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a0522d;">y_true</span> = data.loc[data.tourney == 1, <span style="color: #8b2252;">'team1win'</span>].values
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">return</span> log_loss(y_true, np.median(pi, axis=0))

<span style="color: #a0522d;">log_losses</span> = []
<span style="color: #a0522d;">seasons</span> = <span style="color: #483d8b;">range</span>(1985, 2019)
<span style="color: #a020f0;">for</span> season <span style="color: #a020f0;">in</span> seasons:
<span style="background-color: #f2f2f2;"> </span>   <span style="color: #a020f0;">print</span>(<span style="color: #8b2252;">'season = '</span>.<span style="color: #483d8b;">format</span>(season))
<span style="background-color: #f2f2f2;"> </span>   log_losses.append(evaluate(sm=sm, season=season))
<span style="color: #a020f0;">with</span> <span style="color: #483d8b;">open</span>(<span style="color: #8b2252;">"bradley-terry-logloss.pkl"</span>, <span style="color: #8b2252;">"wb"</span>) <span style="color: #a020f0;">as</span> f:
<span style="background-color: #f2f2f2;"> </span>   pickle.dump({<span style="color: #8b2252;">'log_losses'</span>: log_losses, <span style="color: #8b2252;">'seasons'</span>:seasons}, f, protocol=-1)
</pre>
</div>

<p>
Here is the resulting log-loss curve over all seasons.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #a0522d;">fig</span>, <span style="color: #a0522d;">ax</span> = plt.subplots()
<span style="color: #a0522d;">log_loss_df</span> = pd.read_csv(<span style="color: #8b2252;">'./log_loss_benchmark.csv'</span>).set_index(<span style="color: #8b2252;">'season'</span>)
<span style="color: #a0522d;">log_loss_df</span>[<span style="color: #8b2252;">'bradley-terry'</span>] = log_losses
log_loss_df.plot(ax=ax)
ax.set_title(<span style="color: #8b2252;">'Comparison of Models by Log Loss'</span>)
ax.set_ylabel(<span style="color: #8b2252;">'Log Loss'</span>)
show_fig(<span style="color: #8b2252;">'log_loss.png'</span>)
</pre>
</div>


<div class="figure">
<p><img src="../figs/models/bradley_terry/log_loss.png" alt="log_loss.png" />
</p>
</div>

<p>
The predictive performance of <code>Bradley-Terry</code> model is comparable to
the <code>SeedDiff</code> benchmark model. This is not surprising because they're
using almost the same information.
</p>
</div>
</div>
</div>


<div id="outline-container-org7eda21d" class="outline-2">
<h2 id="org7eda21d"><span class="section-number-2">4</span> Discussion</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgb898a26" class="outline-3">
<h3 id="orgb898a26"><span class="section-number-3">4.1</span> So what have we gained from all this work?</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li><p>
A modeling framework
</p>

<p>
As mentioned above, Bradley-Terry model is a special case of
logistic regression. This is a model we can build on by adding
additional features. We'll also be able to expand on the model by
using hierarchical Bayesian models.
</p></li>

<li><p>
Estimated levels of all teams
</p>

<p>
While only the top 68 teams are seeded, we now have an estimate of
the levels of every team in NCAA. We might be able to leverage this
for future models.
</p></li>

<li><p>
Insight about competitiveness
</p>

<p>
The estimated levels of the teams gives us our first look at
defining and quantifying competitiveness. The <a href="#org2d6322c">posterior histograms</a>
can also help visualize the competitiveness of the games.
</p></li>
</ul>
</div>
</div>


<div id="outline-container-org5bbda81" class="outline-3">
<h3 id="org5bbda81"><span class="section-number-3">4.2</span> Next Steps</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orgc158f29" class="outline-4">
<h4 id="orgc158f29"><span class="section-number-4">4.2.1</span> Include additional features</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Is there an effect of having won in a previous meeting during the season
</p>
<ul class="org-ul">
<li>Does a pair of teams play each other more than once in a season?</li>
</ul>
</div>
</div>
<div id="outline-container-orgfc29f05" class="outline-4">
<h4 id="orgfc29f05"><span class="section-number-4">4.2.2</span> Use score difference information</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
The current model estimates the team levels only based on whether a
team won the game or not. For example, whether a team won by 20 points
or 2 points is irrelevant for this model. We'll try to expand the
model to account for this.
</p>
</div>
</div>
<div id="outline-container-orgdf75290" class="outline-4">
<h4 id="orgdf75290"><span class="section-number-4">4.2.3</span> Allow parameters to vary by conference</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
We might expand the variance component to \(\sigma_{k[i]}^2\) where \(k\)
indexes over conferences. This might help us compare the
competitiveness of the conferences.
</p>
</div>
</div>
<div id="outline-container-org0420704" class="outline-4">
<h4 id="org0420704"><span class="section-number-4">4.2.4</span> Use T-distribution as prior for team levels</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
Normal distribution can be restrictive. For example, it implicitly
constrains the estimates so that 68% of the team levels are within
one standard deviation, 95% within two, and so on. We might use a
T-distribution (infinite mixture of normals) to build a more robust
model.
</p>
</div>
</div>

<div id="outline-container-org895ffc0" class="outline-4">
<h4 id="org895ffc0"><span class="section-number-4">4.2.5</span> Model the data-shift</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
An important question is whether there's any systematic difference
between regular season games and tournament games. For example,
</p>
<ul class="org-ul">
<li>does a team get better or more competitive during the tournament?</li>
<li>does a team get less competitive at the end of regular season when
they've secured a tournament seed?</li>
<li>what happens to a team if a key player is injured at the end of the
season and will miss the tournament?</li>
</ul>
</div>
</div>
</div>
</div>
